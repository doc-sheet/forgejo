platform: linux/amd64

branches:
  exclude: [ main, release/*, soft-fork/*/*, soft-fork/*/*/*, doc-* ]

variables:
 - &golang_image 'golang:1.19'
 - &gitea_test_image 'gitea/test_env:linux-amd64'

workspace:
  base: /go
  path: src/codeberg/gitea

pipeline:
  deps-backend:
    image: *golang_image
    pull: true
    commands:
    - make deps-backend

  security-check:
    image: *golang_image
    group: checks
    pull: true
    commands:
    - make security-check

  lint-backend:
    image: *gitea_test_image
    group: checks
    pull: true
    environment:
    - TAGS=bindata sqlite sqlite_unlock_notify
    - GOSUMDB=sum.golang.org
    commands:
    - make lint-backend

  checks-backend:
    image: *gitea_test_image
    pull: true
    group: checks
    commands:
    - make --always-make checks-backend
